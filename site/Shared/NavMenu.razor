@using System.Text
@using System.ServiceModel.Syndication
@using System.Xml
@using Microsoft.AspNetCore.Components.WebAssembly.Hosting
@inject SiteContext SiteContext
@inject IJSRuntime JSRuntime
@inject IWebAssemblyHostEnvironment HostEnvironment

@code{
    
    string rssFeed = "";

    protected override void OnInitialized()
    {
        var feed = new SyndicationFeed("Title", "Description", new Uri(HostEnvironment.BaseAddress), "RSSUrl", DateTime.Now);
        feed.Copyright = new TextSyndicationContent($"{DateTime.Now.Year} Mitchel Sellers");

        var items = new List<SyndicationItem>();
        foreach (var item in SiteContext.Posts)
        {
            var postUrl = HostEnvironment.BaseAddress + "/post/" + item.Id;
            var title = item.Title;
            var description = item.Title;
            
            items.Add(new SyndicationItem(title, description, new Uri(postUrl), item.Id, DateTimeOffset.Now)); // todo: DATE
        }
        feed.Items = items;
        
        var settings = new XmlWriterSettings
        {
            Encoding = Encoding.UTF8,
            NewLineHandling = NewLineHandling.Entitize,
            NewLineOnAttributes = true,
            Indent = true
        };

        using var stream = new MemoryStream();
        using var xmlWriter = XmlWriter.Create(stream, settings);
        
        var rssFormatter = new Rss20FeedFormatter(feed, false);
        rssFormatter.WriteTo(xmlWriter);
        xmlWriter.Flush();
        rssFeed = Encoding.UTF8.GetString(stream.ToArray());
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JSRuntime.InvokeVoidAsync("setupPhoto");
        await JSRuntime.InvokeVoidAsync("initializeMenu");
    }
}

<div class="slimscroll-menu" id="remove-scroll">
    <div id="sidebar-menu" style="padding: 1em">

        <aside class="widget about-widget">
            @* <div class="widget-title">Adam Drewery</div> *@

            <div class="text-center">
                <img id="photo" src="images/me.jpg" alt="About Me" class="rounded-circle">

                <p>Hello fellow traveller. Its, me, Adam! I'm a programmer, music lover, and slayer of dangerous goblinoids. </p>
            </div>

        </aside>

        <!-- Search widget-->
        <aside class="widget widget_search">
            <form action="/search">
                <input name="q" class="form-control pr-5" style="background-color: #333; color: #eee" type="search" placeholder="Search...">
                <button class="search-button" type="submit">
                    <span class="mdi mdi-magnify"></span>
                </button>
            </form>
        </aside>

        <!-- Tags widget-->
        <aside class="widget widget_tag_cloud">
            <div class="widget-title">Tags</div>
            <div class="tagcloud">

                @{ var tags = SiteContext.Posts.SelectMany(p => p.Tags).Distinct(); }
                @foreach (var tag in tags)
                {
                    <a href="/tag/@tag">@tag</a>
                }

            </div>
        </aside>

        <!-- Recent entries widget-->
        <aside class="widget widget_recent_entries_custom">
            <div class="widget-title">Recent Posts</div>
            <ul>

                @foreach (var post in SiteContext.Posts.Take(3))
                {
                    <li class="clearfix">
                        <div class="wi">
                            <a href="/@post.Id">
                                <img src="images/works/img1.jpg" alt="" class="img-fluid">
                            </a>
                        </div>
                        <div class="wb">
                            <a href="/post/@post.Id">@post.Title</a> <span class="post-date">@post.Date</span>
                        </div>
                    </li>
                }
            </ul>
        </aside>

        <aside class="widget about-widget">
            <div class="widget-title">Elsewhere</div>

            <ul class="socials">
                <li>
                    <a href="@SiteContext.GitHub">
                        <i class="mdi mdi-github-circle"></i>
                    </a>
                </li>
                <li>
                    <a href="@SiteContext.StackOverflow">
                        <i class="mdi mdi-stackoverflow"></i>
                    </a>
                </li>
                <li>
                    <a href="@SiteContext.LinkedIn">
                        <i class="mdi mdi-linkedin"></i>
                    </a>
                </li>
                <li>
                    <a href="data:application/xml;charset=utf-8,@rssFeed" download="rss.xml">
                        <i class="mdi mdi-rss"></i>
                    </a>
                </li>
            </ul>

        </aside>

        <!-- Archives widget-->
        <aside class="widget">
            <div class="widget-title">Archives</div>

            <ul>
                @foreach (var post in SiteContext.Posts)
                {
                    <li><a href="/post/@post.Id">@post.Title</a> (@post.Date)</li>
                }
            </ul>

        </aside>

    </div>
</div>